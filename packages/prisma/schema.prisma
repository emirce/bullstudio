// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider            = "prisma-client"
  output              = "./generated/client"
  importFileExtension = ""
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String               @id @default(cuid())
  name                    String?
  email                   String               @unique
  emailVerified           DateTime?
  image                   String?
  hasCompletedOnboarding  Boolean              @default(false)
  accounts                Account[]
  sessions                Session[]
  organizationMemberships OrganizationMember[]
  workspaceMemberships    WorkspaceMember[]
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique

  workspaces       Workspace[]
  members          OrganizationMember[]
  subscription     Subscription?
  subscriptionPlan SubscriptionPlan     @default(Free)
  stripeCustomerId String?              @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

model Subscription {
  id String @id @default(cuid())

  stripeSubscriptionId String @unique
  stripePriceId        String

  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  plan   SubscriptionPlan
  period SubscriptionPeriod @default(Monthly)

  periodEndsAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([stripeSubscriptionId])
  @@index([organizationId])
}

model OrganizationMember {
  id String @id @default(cuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role OrganizationMemberRole @default(Member)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, userId])
}

model WorkspaceMember {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role WorkspaceMemberRole @default(Member)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, userId])
}

model Workspace {
  id String @id @default(cuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name            String
  slug            String
  members         WorkspaceMember[]
  redisConnection RedisConnection[] 


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, slug])
  @@index([slug])
}

model RedisConnection {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Connection display name
  name String @default("Default Connection")

  // Connection configuration
  host     String
  port     Int     @default(6379)
  database Int     @default(0)
  tls      Boolean @default(false)

  // Encrypted credentials (stored as encrypted string with IV and tag)
  encryptedPassword String?
  passwordIv        String?
  passwordTag       String?

  // Optional username (Redis 6+ ACL)
  username String?

  // Optional TLS certificate (encrypted)
  encryptedTlsCert String?
  tlsCertIv        String?
  tlsCertTag       String?

  // Connection mode
  accessMode RedisAccessMode @default(ReadOnly)

  // Connection health
  status            RedisConnectionStatus @default(Pending)
  lastConnectedAt   DateTime?
  lastHealthCheckAt DateTime?
  lastError         String?

  // Alerts
  alerts Alert[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
}

model Alert {
  id String @id @default(cuid())

  connectionId String
  connection   RedisConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  name        String
  description String?
  queueName   String
  type        AlertType
  enabled     Boolean   @default(true)

  // Configuration (stored as JSON)
  // For FailureRate: { threshold: number, timeWindowMinutes: number, resolveThreshold?: number }
  // For BacklogExceeded: { threshold: number, resolveThreshold?: number }
  // For ProcessingTime*: { threshold: number, timeWindowMinutes: number, resolveThreshold?: number }
  // For MissingWorkers: { gracePeriodMinutes?: number }
  config Json

  // Notification settings
  recipients      String[]
  cooldownMinutes Int      @default(15)

  // Current state
  status          AlertStatus @default(OK)
  lastTriggeredAt DateTime?
  lastResolvedAt  DateTime?
  lastCheckedAt   DateTime?
  lastValue       Float?

  // History
  history AlertHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([status])
  @@index([enabled])
}

model AlertHistory {
  id String @id @default(cuid())

  alertId String
  alert   Alert  @relation(fields: [alertId], references: [id], onDelete: Cascade)

  status  AlertStatus
  value   Float?
  message String?

  createdAt DateTime @default(now())

  @@index([alertId])
  @@index([createdAt])
}


enum OrganizationMemberRole {
  Owner
  Member
}

enum WorkspaceMemberRole {
  Owner
  Member
}

enum SubscriptionPlan {
  Free
  Pro
  Enterprise
}

enum SubscriptionPeriod {
  Monthly
  Yearly
}

enum ProxyAgentStatus {
  WaitingRegistration
  Registered
}

enum RedisAccessMode {
  ReadOnly
  ReadWrite
}

enum RedisConnectionStatus {
  Pending
  Connected
  Failed
  Disconnected
}

enum DataSourceType {
  ProxyAgent
  DirectRedis
}

enum AlertType {
  FailureRate
  BacklogExceeded
  ProcessingTimeAvg
  ProcessingTimeP95
  ProcessingTimeP99
  MissingWorkers
}

enum AlertStatus {
  OK
  Triggered
}
